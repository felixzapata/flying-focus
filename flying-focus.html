<link rel="import" href="../polymer/polymer.html">
<!--
@element flying-focus
@demo demo/index.html
-->

<dom-module id="flying-focus">
  <template>
    <div id="flying-focus"></div>
  </template>
</dom-module>

<script>

(function() {

  Polymer({
    is: 'flying-focus',
    properties: {
      duration: {
        type: Number,
        value: 100
      }
    },

    ready: function() {
      var duration = this.duration / 1000 + 's';
      this.$.flyingFocus.style.transitionDuration = duration;
      this.$.flyingFocus.style.WebkitTransitionDuration = duration;
      document.documentElement.addEventListener('focus', this._onFocus, true);
      document.documentElement.addEventListener('blur', this._onEnd, true);
      document.documentElement.addEventListener('keydown', this._onKeyDown, false);
    }

    movingId: 0,
    prevFocused: null,
    isFirstFocus: true,
    keyDownTime: 0,

    _onKeyDown: function(event) {
      var code = event.which;
      // Show animation only upon Tab or Arrow keys press.
      if (code === 9 || (code > 36 && code < 41)) {
        keyDownTime = now();
      }
    },

    _onFocus: function(event) {
      var target = event.target;
      if (target.id === 'flying-focus') {
        return;
      }
      var offset = offsetOf(target);
      this.$.flyingFocus.style.left = offset.left + 'px';
      this.$.flyingFocus.style.top = offset.top + 'px';
      this.$.flyingFocus.style.width = target.offsetWidth + 'px';
      this.$.flyingFocus.style.height = target.offsetHeight + 'px';

      if (this.isFirstFocus) {
        this.isFirstFocus = false;
        return;
      }

      if (this._now() - this.keyDownTime > 42) {
        return;
      }

      this.onEnd();
      target.classList.add('flying-focus_target');
      this.$.flyingFocus.classList.add('flying-focus_visible');
      this.prevFocused = target;
      this.movingId = setTimeout(this.onEnd, this.DURATION);
    }

    _offsetOf: function(elem) {
      var rect = elem.getBoundingClientRect();
      var docElem = document.documentElement;
      var win = document.defaultView;
      var body = document.body;
      var clientTop  = docElem.clientTop  || body.clientTop  || 0;
      var clientLeft = docElem.clientLeft || body.clientLeft || 0;
      var scrollTop  = win.pageYOffset || docElem.scrollTop  || body.scrollTop;
      var scrollLeft = win.pageXOffset || docElem.scrollLeft || body.scrollLeft;
      var top  = rect.top  + scrollTop  - clientTop;
      var left = rect.left + scrollLeft - clientLeft;
      return {top: top, left: left};
    },

    _onEnd: function() {
      if (!this.movingId) {
        return;
      }
      clearTimeout(movingId);
      this.movingId = 0;
      this.$.flyingFocus.classList.remove('flying-focus_visible');
      this.prevFocused.classList.remove('flying-focus_target');
      this.prevFocused = null;
    }

    _now: function() {
      return new Date().valueOf();
    }
  });

})();

</script>
